{% extends "admin/base_admin.html" %}

{% block title %}Apeko Admin - Analytics{% endblock %}

{% block page_title %}Analytics{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .analytics-card {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 20px;
    }
    
    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .analytics-title {
        font-size: 1.2rem;
        font-weight: 500;
        color: #333;
    }
    
    .analytics-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .analytics-filter {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: white;
    }
    
    .chart-container {
        height: 300px;
    }
    
    .analytics-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .metric-card {
        background-color: #f5f5f5;
        border-radius: 5px;
        padding: 15px;
        text-align: center;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #9d0208;
        margin-bottom: 5px;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #555;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .data-table th, .data-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .data-table th {
        background-color: #f5f5f5;
        font-weight: 500;
    }
    
    .data-table tr:hover {
        background-color: #f9f9f9;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="analytics-filters">
    <select class="analytics-filter">
        <option value="30">Last 30 Days</option>
        <option value="90">Last 90 Days</option>
        <option value="180">Last 6 Months</option>
        <option value="365">Last Year</option>
        <option value="all">All Time</option>
    </select>
    
    <select class="analytics-filter">
        <option value="all">All Property Types</option>
        <option value="residential">Residential</option>
        <option value="commercial">Commercial</option>
        <option value="land">Land</option>
        <option value="other">Other</option>
    </select>
</div>

<div class="analytics-metrics">
    <div class="metric-card">
        <div class="metric-value">{{ analytics.total_appraisals }}</div>
        <div class="metric-label">Total Appraisals</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value">${{ '{:.1f}'.format(analytics.total_property_value / 1000000) }}M</div>
        <div class="metric-label">Total Property Value</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value">{{ '{:.1f}'.format(analytics.avg_days_to_complete) }}</div>
        <div class="metric-label">Avg. Days to Complete</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value">{{ analytics.client_satisfaction }}%</div>
        <div class="metric-label">Client Satisfaction</div>
    </div>
</div>

<div class="analytics-container">
    <div class="analytics-card">
        <div class="analytics-header">
            <h3 class="analytics-title">Appraisals by Property Type</h3>
            <div class="analytics-actions">
                <button class="btn btn-sm btn-secondary"><i class="fas fa-download"></i> Export</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="propertyTypeChart"></canvas>
        </div>
    </div>
    
    <div class="analytics-card">
        <div class="analytics-header">
            <h3 class="analytics-title">Monthly Appraisal Requests</h3>
            <div class="analytics-actions">
                <button class="btn btn-sm btn-secondary"><i class="fas fa-download"></i> Export</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="monthlyRequestsChart"></canvas>
        </div>
    </div>
    
    <div class="analytics-card">
        <div class="analytics-header">
            <h3 class="analytics-title">Average Property Value by Location</h3>
            <div class="analytics-actions">
                <button class="btn btn-sm btn-secondary"><i class="fas fa-download"></i> Export</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="valueByLocationChart"></canvas>
        </div>
    </div>
    
    <div class="analytics-card">
        <div class="analytics-header">
            <h3 class="analytics-title">Completion Time Trends</h3>
            <div class="analytics-actions">
                <button class="btn btn-sm btn-secondary"><i class="fas fa-download"></i> Export</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="completionTimeChart"></canvas>
        </div>
    </div>
</div>

<div class="analytics-card">
    <div class="analytics-header">
        <h3 class="analytics-title">Recent Appraisals</h3>
        <div class="analytics-actions">
            <button class="btn btn-sm btn-secondary"><i class="fas fa-download"></i> Export CSV</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Property</th>
                    <th>Type</th>
                    <th>Client</th>
                    <th>Appraiser</th>
                    <th>Value</th>
                    <th>Completion Date</th>
                    <th>Days to Complete</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>APR-2025-045</td>
                    <td>123 Main St, Anytown</td>
                    <td>Residential</td>
                    <td>John Smith</td>
                    <td>Sarah Johnson</td>
                    <td>$425,000</td>
                    <td>Mar 28, 2025</td>
                    <td>14</td>
                </tr>
                <tr>
                    <td>APR-2025-044</td>
                    <td>456 Oak Ave, Somewhere</td>
                    <td>Commercial</td>
                    <td>XYZ Properties</td>
                    <td>Michael Brown</td>
                    <td>$2,150,000</td>
                    <td>Mar 27, 2025</td>
                    <td>21</td>
                </tr>
                <tr>
                    <td>APR-2025-043</td>
                    <td>789 Pine Blvd, Elsewhere</td>
                    <td>Land</td>
                    <td>ABC Developers</td>
                    <td>Emily Davis</td>
                    <td>$850,000</td>
                    <td>Mar 26, 2025</td>
                    <td>18</td>
                </tr>
                <tr>
                    <td>APR-2025-042</td>
                    <td>101 Maple Dr, Anytown</td>
                    <td>Residential</td>
                    <td>Jane Doe</td>
                    <td>Sarah Johnson</td>
                    <td>$375,000</td>
                    <td>Mar 25, 2025</td>
                    <td>12</td>
                </tr>
                <tr>
                    <td>APR-2025-041</td>
                    <td>202 Cedar Ln, Somewhere</td>
                    <td>Residential</td>
                    <td>Robert Johnson</td>
                    <td>Michael Brown</td>
                    <td>$520,000</td>
                    <td>Mar 24, 2025</td>
                    <td>15</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Property Type Chart
        const propertyTypeCtx = document.getElementById('propertyTypeChart').getContext('2d');
        
        // Get property type data from the server
        const propertyTypeLabels = [];
        const propertyTypeData = [];
        
        {% for prop_type, count in analytics.property_type_distribution.items() %}
            propertyTypeLabels.push('{{ prop_type }}');
            propertyTypeData.push({{ count }});
        {% endfor %}
        
        const propertyTypeChart = new Chart(propertyTypeCtx, {
            type: 'pie',
            data: {
                labels: propertyTypeLabels.length > 0 ? propertyTypeLabels : ['No Data'],
                datasets: [{
                    data: propertyTypeData.length > 0 ? propertyTypeData : [1],
                    backgroundColor: ['#9d0208', '#d00000', '#dc2f02', '#e85d04', '#f48c06'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // Monthly Requests Chart
        const monthlyRequestsCtx = document.getElementById('monthlyRequestsChart').getContext('2d');
        
        // Get monthly data from the server
        const monthlyLabels = [];
        const monthlyData = [];
        
        {% for month, count in analytics.monthly_requests.items() %}
            // Format month from YYYY-MM to MMM
            const monthDate = new Date('{{ month }}-01');
            const monthName = monthDate.toLocaleString('default', { month: 'short' });
            monthlyLabels.push(monthName);
            monthlyData.push({{ count }});
        {% endfor %}
        
        const monthlyRequestsChart = new Chart(monthlyRequestsCtx, {
            type: 'bar',
            data: {
                labels: monthlyLabels.length > 0 ? monthlyLabels : ['No Data'],
                datasets: [{
                    label: 'Appraisal Requests',
                    data: monthlyData.length > 0 ? monthlyData : [0],
                    backgroundColor: '#9d0208',
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Value by Location Chart
        const valueByLocationCtx = document.getElementById('valueByLocationChart').getContext('2d');
        
        // Get location data from the server
        const locationLabels = [];
        const locationData = [];
        
        {% for city, value in analytics.location_values.items() %}
            locationLabels.push('{{ city }}');
            // Convert to thousands
            locationData.push({{ value / 1000 }});
        {% endfor %}
        
        const valueByLocationChart = new Chart(valueByLocationCtx, {
            type: 'bar',
            data: {
                labels: locationLabels.length > 0 ? locationLabels : ['No Data'],
                datasets: [{
                    label: 'Average Property Value ($K)',
                    data: locationData.length > 0 ? locationData : [0],
                    backgroundColor: '#9d0208',
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Completion Time Chart
        const completionTimeCtx = document.getElementById('completionTimeChart').getContext('2d');
        
        // Get completion time data from the server
        const completionLabels = [];
        const completionData = [];
        
        {% for month, days in analytics.completion_trend.items() %}
            // Format month from YYYY-MM to MMM
            const completionDate = new Date('{{ month }}-01');
            const completionMonth = completionDate.toLocaleString('default', { month: 'short' });
            completionLabels.push(completionMonth);
            completionData.push({{ days }});
        {% endfor %}
        
        const completionTimeChart = new Chart(completionTimeCtx, {
            type: 'line',
            data: {
                labels: completionLabels.length > 0 ? completionLabels : ['No Data'],
                datasets: [{
                    label: 'Avg. Days to Complete',
                    data: completionData.length > 0 ? completionData : [0],
                    borderColor: '#9d0208',
                    backgroundColor: 'rgba(157, 2, 8, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}
